"""
Request Interceptor
Intercepts and modifies HTTP/HTTPS requests
"""
import logging
from typing import Dict, List
from collections import deque
from datetime import datetime
import threading
import json

logger = logging.getLogger(__name__)


class RequestInterceptor:
    """Intercepts and logs HTTP requests"""
    
    def __init__(self, max_requests: int = 500):
        self.max_requests = max_requests
        self.requests = deque(maxlen=max_requests)
        self.running = False
        self.lock = threading.Lock()
    
    def start(self):
        """Start request interception"""
        if not self.running:
            self.running = True
            logger.info("Request interception started")
    
    def stop(self):
        """Stop request interception"""
        if self.running:
            self.running = False
            logger.info("Request interception stopped")
    
    def log_request(self, method: str, url: str, headers: Dict = None, 
                   body: str = None, response_status: int = None) -> Dict:
        """Log intercepted request"""
        if not self.running:
            return {}
        
        try:
            request_data = {
                'timestamp': datetime.now().isoformat(),
                'method': method,
                'url': url,
                'headers': headers or {},
                'body': body,
                'response_status': response_status
            }
            
            with self.lock:
                self.requests.append(request_data)
            
            logger.debug(f"Intercepted {method} {url}")
            return request_data
        
        except Exception as e:
            logger.error(f"Error logging request: {e}")
            return {}
    
    def get_requests(self, limit: int = 50) -> List[Dict]:
        """Get intercepted requests"""
        with self.lock:
            return list(self.requests)[-limit:]
    
    def clear_requests(self):
        """Clear intercepted requests"""
        with self.lock:
            self.requests.clear()
        logger.info("Intercepted requests cleared")
    
    def get_request_by_url(self, url: str) -> List[Dict]:
        """Get requests for specific URL"""
        with self.lock:
            return [r for r in self.requests if r['url'] == url]
    
    def modify_request(self, request_id: int, modifications: Dict) -> Dict:
        """Modify intercepted request"""
        try:
            with self.lock:
                if 0 <= request_id < len(self.requests):
                    request = list(self.requests)[request_id]
                    
                    # Apply modifications
                    if 'headers' in modifications:
                        request['headers'].update(modifications['headers'])
                    if 'body' in modifications:
                        request['body'] = modifications['body']
                    
                    logger.info(f"Request {request_id} modified")
                    return request
        
        except Exception as e:
            logger.error(f"Error modifying request: {e}")
        
        return {}
    
    def get_stats(self) -> Dict:
        """Get interception statistics"""
        with self.lock:
            return {
                'running': self.running,
                'total_requests': len(self.requests),
                'max_capacity': self.max_requests
            }
